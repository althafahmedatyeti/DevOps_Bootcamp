
- name: Flush all handlers before sudo lockdown
  meta: flush_handlers
  
# - name: Disable root SSH login
#   lineinfile:
#     path: /etc/ssh/sshd_config
#     regexp: '^PermitRootLogin'
#     line: 'PermitRootLogin no'
#     backup: yes

- name: Restart SSH immediately
  service:
    name: ssh
    state: restarted

- name: Install UFW
  apt:
    name: ufw
    state: present
    update_cache: yes

- name: Allow SSH through UFW
  ufw:
    rule: allow
    name: OpenSSH

- name: Enable UFW firewall
  ufw:
    state: enabled

# -------------------------------
# VALIDATE BEFORE LOCKDOWN
# -------------------------------

- name: Validate sudoers syntax (pre-check)
  become: true
  command: visudo -cf /etc/sudoers

# -------------------------------
# FINAL STEP â€” NO TASKS AFTER THIS
# -------------------------------

# - name: Block root shell escalation via sudo (Ubuntu)
#   copy:
#     dest: /etc/sudoers.d/99-block-root-shell
#     owner: root
#     group: root
#     mode: '0440'
#     content: |
#       Cmnd_Alias ROOT_SHELLS = /bin/su, /bin/bash, /bin/sh, /usr/bin/sudo -i
#       ubuntu ALL=(ALL) !ROOT_SHELLS
